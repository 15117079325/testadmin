<?php

/**
 * ECSHOP 直推人数排行榜
 */

define('IN_ECS', true);

require(dirname(__FILE__) . '/includes/init.php');
require_once(ROOT_PATH . 'languages/' .$_CFG['lang']. '/admin/statistic.php');

$smarty->assign('lang', $_LANG);

// act操作项的初始化

if (empty($_REQUEST['act']))
{
    $_REQUEST['act'] = 'list';
}
else
{
    $_REQUEST['act'] = trim($_REQUEST['act']);
}
if ($_REQUEST['act'] == 'list')
{
    admin_priv('push_list');  //权限控制
    $smarty->assign('ur_here', '直推统计排行榜');
    $smarty->assign('full_page', 1);
    $result = get_result_list();
    $smarty->assign('result_list', $result['item']);
    $smarty->assign('filter', $result['filter']);
    $smarty->assign('record_count', $result['record_count']);
    $smarty->assign('page_count', $result['page_count']);
    assign_query_info();
    $smarty->display('push_list.htm');  //页面跳转
}
/*------------------------------------------------------ */
//-- 翻页，排序
/*------------------------------------------------------ */
elseif ($_REQUEST['act'] == 'query')
{
    admin_priv('push_list');

    // 取得区域分布列表
    $result = get_result_list();
    $smarty->assign('result_list', $result['item']);
    $smarty->assign('filter', $result['filter']);
    $smarty->assign('record_count', $result['record_count']);
    $smarty->assign('page_count', $result['page_count']);
    $sort_flag = sort_flag($result['filter']);
    make_json_result($smarty->fetch('push_list.htm'), '',
        array('filter' => $result['filter'], 'page_count' => $result['page_count']));
}


/**
 * 列表数据
 *
 * @return array
 */
function get_result_list ()
{
    $result = get_filter();

    if($result === false) {

        $filter = array();
        $filter['keywords'] = empty($_REQUEST['keywords']) ? '' : trim($_REQUEST['keywords']);
        if(isset($_REQUEST['is_ajax']) && $_REQUEST['is_ajax'] == 1) {

            $filter['keywords'] = json_str_iconv($filter['keywords']);
        }

        $where = ' WHERE 1 ';

        if($filter['keywords']) {

            $where .= " AND ( u.user_name LIKE '%" 
                    . mysql_like_quote($filter['keywords']) . "%' or u.email like '%" 
                    . mysql_like_quote($filter['keywords']) . "%' or u.mobile_phone like '%"
                    . mysql_like_quote($filter['keywords']) . "%' ) ";
        }

        $sql = "SELECT COUNT(*) FROM (SELECT count(*) FROM `xm_mq_users_extra` AS mue LEFT JOIN `xm_users` AS u ON mue.`user_id` = u.`user_id`   $where GROUP BY mue.user_id ) tmp";

        $filter['record_count'] = $GLOBALS['db']->getOne($sql);

        // 分页大小
        $filter = page_and_size($filter);

        /*20180404 1423 V - modify the SQL*/
        $sql = "SELECT COUNT(x.user_id) AS uco_0, x.invite_user_id, u.user_name, u.user_id  FROM `xm_mq_users_extra` AS x LEFT JOIN `xm_users` AS u on x.invite_user_id = u.user_id
                $where GROUP BY invite_user_id ORDER BY uco_0 DESC";

        $sql .= ' LIMIT ' . $filter['start'] . ','. $filter['page_size'];
        set_filter($filter, $sql);

    } else {

        $sql = $result['sql'];
        $filter = $result['filter'];

    }

    $list = $GLOBALS['db']->getAll($sql);

    foreach ($list as $k => $v) {
        
        $list[$k]['uco_1'] = get_lower($v['user_id']); // 间接推广人数
        $list[$k]['uco_2'] = $list[$k]['uco_1'] + $v['uco_0']; // 总推广人数
        $GLOBALS['u_invi_c'] = 0;
    }

    $arr = array(
        'item' => $list, 'filter' => $filter, 'page_count' => $filter['page_count'], 'record_count' => $filter['record_count']
    );
    return $arr;
}


/*201804 14 V 递归查询间推人数*/
function get_lower($str, $count = -1) {

    if (!$str) { return false; }

    // var_dump($count);

    $GLOBALS['u_invi_c'] += $count;

    $sql = "select user_id from xm_mq_users_extra where invite_user_id in ($str)";

    $list = $GLOBALS['db']->getAll($sql);

    if (count($list) != 0) {

        foreach ($list as $key => $value) {
        
            $ll[] = $value['user_id'];
        }

        $str = implode(',', $ll);

        // 间推的人数统计 | 当 $count == -1, 说明上面的 SQL 查询的直推的结果，这里的人数要过滤掉
        $inv_c = ($count == -1) ? 0 : count($list) ;

        get_lower($str, $inv_c);
    }

    // 从 -1 算起，少了一个人，要加上
    return $GLOBALS['u_invi_c'] + 1;
}

#select count(user_id) as uco, invite_user_id  from xm_mq_users_extra group by invite_user_id order by uco desc
#select * from xm_mq_users_extra where invite_user_id = 13911 ,129

#select * from xm_mq_users_extra where invite_user_id in (11156,11195,11388,11671,11673,11676,11679,11683,11685,11687,11691,11692,11694,11697,11823,11828,11862,11891,11920,11938,12018,12024,12027,12041,12044,12045,12047,12048,12050,12051,12053,12054,12056,12057,12060,12063,12075,12137,12139,12160,12403,12458,12463,12466,12467,12469,12472,12481,12528,12587,13175,13227,13232,13235,13236,13246,13250,13252,13279,13288,13299,13476,13478,13481,13597,13601,13603,13708,13795,14677,14687,14694,14824,16794,16795,16796,16797,16798,16799,16800,16819,17091,17110,17115,17117,17119,17120,17121,17123,17145,17146,17247,17499,17682,17684,17685,17729,17730,17731,17734,17735,17736,17737,17738,17739,17740,17921,17940,17975,17991,18030,18259,18268,18284,18287,18373,18441,18682,18805,18815,18847,18886,18887,18922,18961,18966,18969,19200,19769) 167

#select * from xm_mq_users_extra where invite_user_id in (11211,11245,11391,11730,11732,11733,11734,11735,11737,11738,11739,11741,11742,11743,11746,11747,11748,11750,11752,11754,11867,11912,11913,11916,11922,11927,11928,11932,11940,11946,11953,11960,11962,11967,11971,11982,12043,12061,12066,12067,12069,12071,12093,12095,12098,12099,12107,12173,12223,12286,12308,12317,12326,12400,12482,12486,12490,12492,12494,12495,12497,12533,12541,12546,12591,12598,12614,12620,12657,12904,12910,12915,12919,12926,12934,12950,13197,13261,13268,13270,13274,13280,13283,13287,13292,13391,13441,13644,13646,13713,13796,14827,14829,14833,14837,14841,14844,14849,14852,14854,16604,16605,16606,16607,16609,16611,16740,16742,16743,17147,17148,17149,17150,17151,17152,17153,17154,17155,17192,17193,17194,17195,17197,17199,17200,17201,17202,17248,17349,17351,17448,17500,17501,17502,17503,17505,17506,17507,17508,17509,17533,17534,17874,17976,18285,18288,18289,18290,18291,18294,18295,18348,18349,18408,18469,18470,18516,18806,18933,19188,19273,19310,19317,19398,19543,19775,20119) 113

#select * from xm_mq_users_extra where invite_user_id in (11274,11395,11892,11896,11898,11901,11903,11907,11909,11915,11917,11919,11921,11925,11929,11931,11934,11937,11947,11954,11958,11974,11975,12102,12125,12199,12224,12234,12291,12419,12425,12439,12445,12452,12459,12473,12474,12613,12629,12644,12770,12784,12786,12791,12955,12961,12966,12967,13220,13416,13418,13419,13420,13422,13424,13443,13445,13448,13451,13455,13458,13517,13551,13552,13553,13560,13578,13839,14543,14838,14842,16613,16621,16629,16630,16632,16634,16635,16636,16647,16651,16744,16745,17156,17157,17158,17159,17160,17161,17162,17163,17164,17249,17350,17354,17675,17708,18292,18308,18309,18381,18409,18413,18490,18594,18807,18808,18809,18810,18811,18812,19296,20109) 76

#select * from xm_mq_users_extra where invite_user_id in (11992,12058,12062,12068,12070,12072,12304,12315,12487,12973,13031,13049,13051,13053,13054,13057,13060,13063,13086,13088,13091,13094,13096,13099,13101,13195,13196,13430,13512,13522,13524,13525,13541,13554,13555,13556,13557,13559,13582,13753,13758,13760,13868,16334,16638,16641,16642,16644,16646,16648,16653,16654,16656,17168,17170,17171,17172,17173,17174,17175,17177,17178,17317,17319,17320,17322,17324,17332,17355,17634,17676,18414,18415,18434,18491,19297) 118

#select * from xm_mq_users_extra where invite_user_id in (11994,12012,12348,12392,12393,12394,12396,12397,12398,12399,12436,12440,12441,12442,12446,12448,12449,12450,13004,13015,13017,13018,13020,13024,13026,13077,13108,13113,13116,13121,13125,13129,13131,13146,13157,13162,13171,13180,13184,13187,13189,13194,13404,13412,13414,13415,13421,13518,13521,13527,13529,13530,13532,13533,13534,13537,13540,13544,13547,13561,13562,13564,13790,13810,13812,15667,15687,15697,15699,15703,15708,15710,16263,16335,16337,16449,16815,16822,16823,16831,16832,16834,16836,16837,16839,16840,16841,16843,16844,16846,16848,16850,16855,16856,16857,16860,16863,16876,17179,17181,17182,17183,17185,17186,17187,17188,17190,17462,17552,17554,17555,17556,17557,17560,17639,18007,18008,19298) 107

#select * from xm_mq_users_extra where invite_user_id in (11998,12017,12038,12355,12359,12361,12363,12365,12376,12401,12420,12421,12423,12424,12426,12428,12429,12430,12432,13027,13029,13032,13042,13047,13052,13056,13141,13142,13147,13148,13151,13152,13155,13433,13434,13546,13568,13570,13574,13586,13628,13629,13630,13631,13633,13635,13660,13791,13792,13793,13800,13802,13803,13804,13806,13807,13808,15712,15719,15720,15725,15728,16233,16234,16235,16241,16244,16245,16246,16248,16250,16390,16399,16404,16405,16413,16431,16452,16454,16455,16456,16457,16460,16477,16478,16480,16813,16849,16879,16881,16883,16886,16888,16889,16890,16891,16963,17463,17465,17466,17467,17468,17469,17476,17478,17561,18009) 107

#select * from xm_mq_users_extra where invite_user_id in (12004,12021,12022,12026,12028,12039,12040,12405,12509,12510,12512,12514,12515,12517,12518,12520,12521,12523,12524,12525,12581,12584,12596,12603,12679,13072,13078,13080,13083,13095,13103,13109,13565,13636,13648,13650,13652,13653,13655,13656,13663,13664,13665,13667,13668,13672,13675,13676,13715,13716,13719,13720,13722,13723,13794,16251,16252,16253,16254,16255,16256,16257,16258,16259,16260,16261,16262,16406,16458,16461,16463,16482,16484,16486,16639,16687,16688,16690,16697,16698,16700,16752,16753,16754,16755,16756,16757,16853,16858,16859,16862,16865,16866,16867,16868,16872,16884,16967,16971,16984,17479,17480,17481,17482,17483,17484,17485) 100

# select * from xm_mq_users_extra where invite_user_id in (12009,12011,12013,12015,12016,12020,12023,12025,12029,12031,12032,12033,12034,12035,12036,12409,12413,12414,12415,12417,12418,12529,12535,12536,12539,12542,12543,12547,12561,12562,12563,12566,12615,12618,12622,12626,12631,12637,12643,12646,12654,12665,12684,12685,12688,12689,12694,12696,12697,13123,13134,13154,13160,13173,13182,13188,13243,13567,13569,13571,13572,13573,13576,13577,13579,13581,13583,13585,13588,13589,13598,13600,13677,13678,13679,13725,13731,15627,15631,15633,15660,16702,16704,16705,16706,16758,16759,16873,16875,16878,16893,16902,16903,16904,16905,16906,16921,16922,17727,17864) 46

# select * from xm_mq_users_extra where invite_user_id in (12569,12572,12675,12692,12700,12707,12708,12710,12712,12713,12714,12715,12716,12717,12718,12724,12727,12733,12738,12743,12749,13602,13604,13605,13606,13607,13608,13609,13610,13613,13614,13615,13622,15661,16895,16896,16898,16899,16925,16928,16930,16932,16933,16934,16935,17696) 38

# select * from xm_mq_users_extra where invite_user_id in (12719,12720,12722,12750,12753,12758,12760,12765,12767,12772,12780,12782,12789,12796,12838,12851,12852,12853,12854,12855,12856,13356,13617,13618,13619,13620,13621,13624,16937,16939,16941,16943,16945,16947,17658,17660,17690,17865) 22

# select * from xm_mq_users_extra where invite_user_id in (12811,12813,12857,12858,12859,12860,12861,12862,12863,12864,12865,12866,12867,12868,12869,13336,13346,13347,13349,13351,13353,17691) 25

# select * from xm_mq_users_extra where invite_user_id in (12870,12871,12872,12873,12876,12877,12879,12880,12881,12883,12884,12889,12891,12893,12894,12895,12896,12897,13357,13359,13361,13362,13365,13368,13369) 9

# select * from xm_mq_users_extra where invite_user_id in (12886,12887,12888,12899,12900,13371,13374,13375,18476) 0